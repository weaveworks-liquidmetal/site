"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[7439],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>h});var r=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var c=r.createContext({}),s=function(e){var t=r.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},u=function(e){var t=s(e.components);return r.createElement(c.Provider,{value:t},e.children)},p="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var n=e.components,o=e.mdxType,a=e.originalType,c=e.parentName,u=i(e,["components","mdxType","originalType","parentName"]),p=s(n),d=o,h=p["".concat(c,".").concat(d)]||p[d]||m[d]||a;return n?r.createElement(h,l(l({ref:t},u),{},{components:n})):r.createElement(h,l({ref:t},u))}));function h(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var a=n.length,l=new Array(a);l[0]=d;var i={};for(var c in t)hasOwnProperty.call(t,c)&&(i[c]=t[c]);i.originalType=e,i[p]="string"==typeof e?e:o,l[1]=i;for(var s=2;s<a;s++)l[s]=n[s];return r.createElement.apply(null,l)}return r.createElement.apply(null,n)}d.displayName="MDXCreateElement"},7804:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>l,default:()=>m,frontMatter:()=>a,metadata:()=>i,toc:()=>s});var r=n(7462),o=(n(7294),n(3905));const a={title:"CAPMVM"},l=void 0,i={unversionedId:"troubleshooting/capmvm",id:"troubleshooting/capmvm",title:"CAPMVM",description:"Understanding common CAPMVM errors.",source:"@site/docs/troubleshooting/capmvm.md",sourceDirName:"troubleshooting",slug:"/troubleshooting/capmvm",permalink:"/site/docs/troubleshooting/capmvm",draft:!1,editUrl:"https://github.com/weaveworks-liquidmetal/site/tree/main/docs/troubleshooting/capmvm.md",tags:[],version:"current",frontMatter:{title:"CAPMVM"},sidebar:"docs",previous:{title:"MicroVMs",permalink:"/site/docs/troubleshooting/microvm"}},c={},s=[{value:"Failed to create client for Cluster default/lm-demo",id:"failed-to-create-client-for-cluster-defaultlm-demo",level:3},{value:"Error while dialing dial tcp",id:"error-while-dialing-dial-tcp",level:3},{value:"Deleting a cluster hangs forever",id:"deleting-a-cluster-hangs-forever",level:3}],u={toc:s},p="wrapper";function m(e){let{components:t,...n}=e;return(0,o.kt)(p,(0,r.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("p",null,"Understanding common ",(0,o.kt)("inlineCode",{parentName:"p"},"CAPMVM")," errors."),(0,o.kt)("p",null,"Both CAPMVM and CAPI logs can be found by querying the management cluster."),(0,o.kt)("p",null,"To see the CAPMVM controller logs, look for the pod called ",(0,o.kt)("inlineCode",{parentName:"p"},"capmvm-controller-manager-XXXXX")," in\nthe ",(0,o.kt)("inlineCode",{parentName:"p"},"capmvm-system")," namespace. In those logs you will be able to see the controller\nreconcile ",(0,o.kt)("inlineCode",{parentName:"p"},"MicrovmMachine")," types and connect to the given flintlock host(s) to\ncreate MicroVMs."),(0,o.kt)("p",null,"Various CAPI controllers are also running:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"The logs of ",(0,o.kt)("inlineCode",{parentName:"li"},"capi-controller-manager-XXXX")," in ",(0,o.kt)("inlineCode",{parentName:"li"},"capi-system")," will show\nyou the overall orchestration of the workload cluster."),(0,o.kt)("li",{parentName:"ul"},"The logs of ",(0,o.kt)("inlineCode",{parentName:"li"},"capi-kubeadm-control-plane-controller-manager-XXXX")," in ",(0,o.kt)("inlineCode",{parentName:"li"},"capi-kubeadm-control-plane-system"),"\nwill show the bootstrapping of the first created MicroVM as a control-plane node."),(0,o.kt)("li",{parentName:"ul"},"The logs of ",(0,o.kt)("inlineCode",{parentName:"li"},"capi-kubeadm-bootstrap-controller-manager-XXXX")," in ",(0,o.kt)("inlineCode",{parentName:"li"},"capi-kubeadm-bootstrap-system"),"\nwill show the bootstrapping of all subsequent MicroVMs as worker nodes.")),(0,o.kt)("h3",{id:"failed-to-create-client-for-cluster-defaultlm-demo"},"Failed to create client for Cluster default/lm-demo"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'failed to create client for Cluster default/lm-demo: Get \\"https://192.168.10.25:6443/api?timeout=10s\\\n')),(0,o.kt)("p",null,"This error is expected for the first ~5mins of cluster creation. We are waiting\nfor:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"CAPMVM to instruct flintlock to create a MicroVM"),(0,o.kt)("li",{parentName:"ul"},"The MicroVM to boot"),(0,o.kt)("li",{parentName:"ul"},"Images to download and the kubelet process to start")),(0,o.kt)("p",null,"The time to do this will vary depending on numerous factors, including your network\nspeeds, the backing storage of your boards and how much memory is available."),(0,o.kt)("p",null,"If you still see the error after 5 mins, check to see whether the MicroVM booted correctly.\nSee the ",(0,o.kt)("a",{parentName:"p",href:"/docs/troubleshooting/capmvm"},"troubleshooting page for MicroVMs"),". Common causes for failure are:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"There is not enough RAM allocated to the MicroVM"),(0,o.kt)("li",{parentName:"ul"},"The MicroVM cannot access a dhcp service or get an IP"),(0,o.kt)("li",{parentName:"ul"},"The MicroVM cannot resolve addresses, so cannot pull required k8s images"),(0,o.kt)("li",{parentName:"ul"},"The address chosen for the ",(0,o.kt)("inlineCode",{parentName:"li"},"kube-vip")," is not free or accessible on that subnet"),(0,o.kt)("li",{parentName:"ul"},"Some other kubelet issue has occurred and the service has not been able to start")),(0,o.kt)("h3",{id:"error-while-dialing-dial-tcp"},"Error while dialing dial tcp"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'failed getting microvm: rpc error: code = Unavailable desc = connection error: desc = \\"transport: Error while dialing dial tcp 192.168.1.216:9090: i/o timeout\\\n')),(0,o.kt)("p",null,"It means your ",(0,o.kt)("inlineCode",{parentName:"p"},"flintlockd")," service is no longer accessible at that address."),(0,o.kt)("p",null,"Check that flintlock is still running on that board ",(0,o.kt)("inlineCode",{parentName:"p"},"systemctl status flintlockd.service"),".\nRefer to the ",(0,o.kt)("a",{parentName:"p",href:"/docs/troubleshooting/flintlock"},"flintlock troubleshooting")," if it is not."),(0,o.kt)("p",null,"If your flintlockd service is running fine, check that the address is correct, or that\nit is accessible on that particular interface."),(0,o.kt)("h3",{id:"deleting-a-cluster-hangs-forever"},"Deleting a cluster hangs forever"),(0,o.kt)("p",null,"Sometimes trying to delete a cluster at the wrong moment of creation (or when something\nwent wrong with that creation to begin with) can cause a delete to hang forever."),(0,o.kt)("p",null,"Check the CAPMVM logs on your management cluster to see if something is obviously failing."),(0,o.kt)("admonition",{type:"note"},(0,o.kt)("p",{parentName:"admonition"},(0,o.kt)("inlineCode",{parentName:"p"},'failed to create client for Cluster <foo>/<bar>: Get \\"https://192.168.10.25:6443/api?timeout=10s\\')," is expected and not an issue\nfor a delete.")),(0,o.kt)("p",null,"If CAPMVM is trying but unable to connect to a flintlock service, check that it is running."),(0,o.kt)("p",null,"To force the CAPI cluster deletion, you can edit various objects in order.\nStart with the ",(0,o.kt)("inlineCode",{parentName:"p"},"MicrovmMachine")," and remove the finalizer."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"   finalizers:\n   - microvmmachine.infrastructure.cluster.x-k8s.io\n")),(0,o.kt)("p",null,"That should do the trick, but if not, proceed to do the same to the ",(0,o.kt)("inlineCode",{parentName:"p"},"Machine"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"  finalizers:\n  - machine.cluster.x-k8s.io\n")),(0,o.kt)("p",null,"And again to the ",(0,o.kt)("inlineCode",{parentName:"p"},"Cluster"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"  finalizers:\n  - cluster.cluster.x-k8s.io\n")),(0,o.kt)("p",null,"If there are any MicroVMs still running on the device, you can clean them up\nwith ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/warehouse-13/hammertime"},(0,o.kt)("inlineCode",{parentName:"a"},"hammertime"))," or kill the ",(0,o.kt)("inlineCode",{parentName:"p"},"firecracker")," processes and instruct ",(0,o.kt)("inlineCode",{parentName:"p"},"containerd"),"\nto remove the lease and clear the content store."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"sudo killall firecracker\n\nctr -n flintlock -a /var/run/containerd-dev/containerd.sock leases ls\nctr -n flintlock -a /var/run/containerd-dev/containerd.sock leases del <id>\n")))}m.isMDXComponent=!0}}]);